<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podaż Pieniądza w Polsce</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f4f7fa;
            margin: 0;
            padding: 0;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        h1, h2 {
            text-align: center;
            color: #1a3c5e;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 50px;
        }
        h2 {
            font-size: 2rem;
            margin: 40px 0 30px;
        }
        .columns {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .column-container {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
        }
        .column {
            background: linear-gradient(135deg, #ffffff, #e8eff5);
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            text-align: center;
            transition: transform 0.3s ease;
            border-top: 5px solid transparent;
        }
        .m3-column {
            border-top-color: #9f7aea;
        }
        .m2-column {
            border-top-color: #4299e1;
        }
        .m1-column {
            border-top-color: #48bb78;
        }
        .column:hover {
            transform: translateY(-5px);
        }
        .column h2 {
            font-size: 3.5rem;
            font-weight: 700;
            margin: 0 0 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.15);
            display: inline-block;
        }
        .m3-header {
            background: linear-gradient(135deg, #6b46c1, #9f7aea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .m2-header {
            background: linear-gradient(135deg, #2b6cb0, #4299e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .m1-header {
            background: linear-gradient(135deg, #2f855a, #48bb78);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .value {
            font-size: 2rem;
            font-weight: 600;
            color: #2c5282;
            margin: 10px 0;
        }
        .change {
            font-size: 1.1rem;
            margin: 5px 0;
        }
        .positive {
            color: #28a745;
        }
        .negative {
            color: #dc3545;
        }
        .neutral {
            color: #666;
        }
        .date-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
        }
        .text-box {
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-top: 20px;
            text-align: left;
        }
        .text-content {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        .charts-section {
            margin-top: 60px;
        }
        .chart-columns {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        .chart-column {
            flex: 1;
            min-width: 300px;
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .toggles {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 20px;
        }
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toggle-label {
            font-size: 0.9rem;
            color: #333;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 20px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #4299e1;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        #brush-chart-values, #brush-chart-changes {
            margin-top: -10px;
            margin-bottom: 20px;
        }
        .apexcharts-selection-rect, 
        .apexcharts-svg rect.apexcharts-zoom-rect, 
        .apexcharts-svg rect.apexcharts-selection-rect {
            cursor: move;
        }
        @media (max-width: 768px) {
            .apexcharts-zoom-icon,
            .apexcharts-selection-icon,
            .apexcharts-pan-icon,
            .apexcharts-reset-icon {
                transform: scale(1.5);
                margin: 0 8px;
            }
            #brush-chart-values, #brush-chart-changes {
                height: 160px !important;
            }
            .apexcharts-selection-rect .apexcharts-selection-rect-handle {
                width: 20px !important;
                height: 20px !important;
                transform: translate(-50%, -50%);
            }
        }
        @media (max-width: 768px) {
            .columns, .chart-columns {
                flex-direction: column;
                align-items: center;
            }
            .column-container, .chart-column {
                width: 100%;
                max-width: 400px;
            }
            .toggles {
                flex-direction: column;
                align-items: center;
            }
        }
        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5);
        }
        /* Style dla tabeli */
        .table-section {
            margin-top: 60px;
        }
        .table-container {
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            padding: 20px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #e8eff5;
        }
        th:first-child, td:first-child {
            text-align: left;
        }
        th {
            background: linear-gradient(135deg, #f4f7fa, #e8eff5);
            font-weight: 600;
            color: #1a3c5e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        tr.category-row {
            background: #f0f4f8;
            font-weight: 700;
            border-top: 2px solid #ddd;
        }
        tr.subcategory-row[data-level="1"] {
            background: #f9fafb;
            font-weight: 600;
        }
        tr.subcategory-row[data-level="2"] {
            background: #fff;
            font-weight: normal;
        }
        tr.subcategory-row[data-level="3"] {
            background: #fff;
            font-weight: normal;
        }
        tr.subcategory-row[data-level="4"] {
            background: #fff;
            font-weight: normal;
        }
        tr.subcategory-row[data-level="1"] td:first-child {
            padding-left: 30px;
        }
        tr.subcategory-row[data-level="2"] td:first-child {
            padding-left: 50px;
        }
        tr.subcategory-row[data-level="3"] td:first-child {
            padding-left: 70px;
        }
        tr.subcategory-row[data-level="4"] td:first-child {
            padding-left: 90px;
        }
        .toggle-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
            transition: transform 0.3s;
            color: #4299e1;
        }
        .toggle-icon.expanded {
            transform: rotate(90deg);
            color: #2c5282;
        }
        tr[data-id="m3"] .toggle-icon {
            display: none;
        }
        .m1-row {
            border-left: 4px solid #48bb78;
        }
        .m2-row {
            border-left: 4px solid #4299e1;
        }
        .m3-row {
            border-left: 4px solid #9f7aea;
        }
        tr.hidden {
            display: none;
        }
        @media (max-width: 768px) {
            .table-container {
                overflow-x: auto;
            }
            table {
                min-width: 800px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Podaż Pieniądza w Polsce</h1>
        <div class="columns">
            <div class="column-container">
                <div class="column m3-column">
                    <h2 class="m3-header">M3</h2>
                    <div class="value" id="m3-value">Ładowanie...</div>
                    <div class="change" id="m3-mm">Ładowanie...</div>
                    <div class="change" id="m3-rr">Ładowanie...</div>
                    <div class="date-info" id="m3-date">Ładowanie...</div>
                </div>
                <div class="text-box">
                    <div class="text-content" id="m3-text">
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                    </div>
                </div>
            </div>
            <div class="column-container">
                <div class="column m2-column">
                    <h2 class="m2-header">M2</h2>
                    <div class="value" id="m2-value">Ładowanie...</div>
                    <div class="change" id="m2-mm">Ładowanie...</div>
                    <div class="change" id="m2-rr">Ładowanie...</div>
                    <div class="date-info" id="m2-date">Ładowanie...</div>
                </div>
                <div class="text-box">
                    <div class="text-content" id="m2-text">
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                    </div>
                </div>
            </div>
            <div class="column-container">
                <div class="column m1-column">
                    <h2 class="m1-header">M1</h2>
                    <div class="value" id="m1-value">Ładowanie...</div>
                    <div class="change" id="m1-mm">Ładowanie...</div>
                    <div class="change" id="m1-rr">Ładowanie...</div>
                    <div class="date-info" id="m1-date">Ładowanie...</div>
                </div>
                <div class="text-box">
                    <div class="text-content" id="m1-text">
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                    </div>
                </div>
            </div>
        </div>
        <section class="charts-section">
            <h2>Wykres skumulowany</h2>
            <div class="chart-columns">
                <div class="chart-column">
                    <div id="values-chart"></div>
                    <div id="brush-chart-values"></div>
                </div>
                <div class="chart-column">
                    <div class="toggles">
                        <div class="toggle-container">
                            <span class="toggle-label">r/r</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="period-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">m/m</span>
                        </div>
                        <div class="toggle-container">
                            <span class="toggle-label">mld PLN</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="unit-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">%</span>
                        </div>
                    </div>
                    <div id="changes-chart"></div>
                    <div id="brush-chart-changes"></div>
                </div>
            </div>
        </section>
        <section class="table-section">
            <h2>Składniki M3</h2>
            <div class="table-container">
                <table id="m3-table">
                    <thead>
                        <tr>
                            <th>Składnik M3</th>
                            <th>Wartość nominalna (mld PLN)</th>
                            <th>Udział (%)</th>
                            <th>Zmiana m/m (mld PLN)</th>
                            <th>Zmiana m/m (%)</th>
                            <th>Zmiana r/r (mld PLN)</th>
                            <th>Zmiana r/r (%)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
    </div>
    <script>
        function isMobileDevice() {
            return window.innerWidth <= 768;
        }

        async function loadData() {
            try {
                const response = await fetch('am_data.json');
                if (!response.ok) {
                    throw new Error(`Problem z pobieraniem danych: ${response.status} ${response.statusText}`);
                }
                const jsonData = await response.json();
                
                if (!jsonData.columns || !Array.isArray(jsonData.columns)) {
                    throw new Error('Nieprawidłowa struktura danych JSON: brak tablicy columns');
                }

                const columns = {
                    m3: jsonData.columns.find(col => col.column_id === 23),
                    m2: jsonData.columns.find(col => col.column_id === 19),
                    m1: jsonData.columns.find(col => col.column_id === 11),
                    cash_outside_mif: jsonData.columns.find(col => col.column_id === 1),
                    cash_with_mif: jsonData.columns.find(col => col.column_id === 2),
                    cash_in_mif: jsonData.columns.find(col => col.column_id === 3),
                    deposits_current: jsonData.columns.find(col => col.column_id === 4),
                    households_current: jsonData.columns.find(col => col.column_id === 5),
                    other_fin_current: jsonData.columns.find(col => col.column_id === 6),
                    nonfin_current: jsonData.columns.find(col => col.column_id === 7),
                    nonprofit_current: jsonData.columns.find(col => col.column_id === 8),
                    localgov_current: jsonData.columns.find(col => col.column_id === 9),
                    social_funds_current: jsonData.columns.find(col => col.column_id === 10),
                    deposits_2y: jsonData.columns.find(col => col.column_id === 12),
                    households_2y: jsonData.columns.find(col => col.column_id === 13),
                    other_fin_2y: jsonData.columns.find(col => col.column_id === 14),
                    nonfin_2y: jsonData.columns.find(col => col.column_id === 15),
                    nonprofit_2y: jsonData.columns.find(col => col.column_id === 16),
                    localgov_2y: jsonData.columns.find(col => col.column_id === 17),
                    social_funds_2y: jsonData.columns.find(col => col.column_id === 18),
                    repo_operations: jsonData.columns.find(col => col.column_id === 20),
                    debt_securities_2y: jsonData.columns.find(col => col.column_id === 21),
                    money_market_funds: jsonData.columns.find(col => col.column_id === 22)
                };

                // Przetwarzanie danych dla ramek
                for (const [key, column] of Object.entries({ m3: columns.m3, m2: columns.m2, m1: columns.m1 })) {
                    if (!column) {
                        document.getElementById(`${key}-value`).textContent = 'Brak danych';
                        document.getElementById(`${key}-mm`).textContent = 'Brak danych';
                        document.getElementById(`${key}-rr`).textContent = 'Brak danych';
                        document.getElementById(`${key}-date`).textContent = 'Brak danych';
                        document.getElementById(`${key}-text`).textContent = `Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.`;
                        continue;
                    }

                    const data = column.data;
                    const latest = data[data.length - 1];
                    const latestValue = latest.value / 1000;
                    const latestDateObj = new Date(latest.date);
                    const latestMonth = latestDateObj.getMonth();
                    const latestYear = latestDateObj.getFullYear();

                    const prevMonth = latestMonth === 0 ? 11 : latestMonth - 1;
                    const prevYear = latestMonth === 0 ? latestYear - 1 : latestYear;
                    const prevMonthYearMonth = `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}`;
                    const prevMonthEntry = data.find(entry => entry.date.slice(0, 7) === prevMonthYearMonth);
                    const prevMonthValue = prevMonthEntry ? prevMonthEntry.value / 1000 : null;

                    const prevYearDate = new Date(latestDateObj);
                    prevYearDate.setFullYear(prevYearDate.getFullYear() - 1);
                    const prevYearYearMonth = prevYearDate.toISOString().slice(0, 7);
                    const prevYearEntry = data.find(entry => entry.date.slice(0, 7) === prevYearYearMonth);
                    const prevYearValue = prevYearEntry ? prevYearEntry.value / 1000 : null;

                    let mmChange = null, mmPercent = null, rrChange = null, rrPercent = null;
                    if (prevMonthValue !== null) {
                        mmChange = latestValue - prevMonthValue;
                        mmPercent = (mmChange / prevMonthValue) * 100;
                    }
                    if (prevYearValue !== null) {
                        rrChange = latestValue - prevYearValue;
                        rrPercent = (rrChange / prevYearValue) * 100;
                    }

                    document.getElementById(`${key}-value`).textContent = `${latestValue.toFixed(2)} mld PLN`;
                    document.getElementById(`${key}-mm`).textContent = prevMonthValue !== null
                        ? `${mmChange >= 0 ? '+' : ''}${mmChange.toFixed(2)} mld m/m (${mmPercent.toFixed(2)}%)`
                        : 'Brak danych m/m';
                    document.getElementById(`${key}-mm`).className = `change ${mmChange >= 0 ? 'positive' : mmChange < 0 ? 'negative' : 'neutral'}`;
                    document.getElementById(`${key}-rr`).textContent = prevYearValue !== null
                        ? `${rrChange >= 0 ? '+' : ''}${rrChange.toFixed(2)} mld r/r (${rrPercent.toFixed(2)}%)`
                        : 'Brak danych r/r';
                    document.getElementById(`${key}-rr`).className = `change ${rrChange >= 0 ? 'positive' : rrChange < 0 ? 'negative' : 'neutral'}`;
                    document.getElementById(`${key}-date`).textContent = `Stan na ${latest.date}, źródło: NBP`;
                    document.getElementById(`${key}-text`).textContent = `Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.`;
                }

                // Przetwarzanie danych dla wykresów
                const dates = columns.m3 ? columns.m3.data.map(d => {
                    const [year, month, day] = d.date.split("-").map(Number);
                    return Date.UTC(year, month - 1, day);
                }) : [];
                const valuesData = {
                    m3: columns.m3 ? columns.m3.data.map(d => d.value / 1000) : [],
                    m2: columns.m2 ? columns.m2.data.map(d => d.value / 1000) : [],
                    m1: columns.m1 ? columns.m1.data.map(d => d.value / 1000) : []
                };

                // Przetwarzanie danych dla tabeli
                const tableData = [];
                const m3Total = columns.m3 && columns.m3.data.length > 0 ? columns.m3.data[columns.m3.data.length - 1].value / 1000 : null;

                const calculateMetrics = (column, latestDateObj) => {
                    if (!column || !column.data || column.data.length === 0) {
                        return {
                            value: null,
                            share: null,
                            mmChange: null,
                            mmPercent: null,
                            rrChange: null,
                            rrPercent: null
                        };
                    }
                    const data = column.data;
                    const latest = data[data.length - 1];
                    const latestValue = latest.value / 1000;
                    const latestMonth = latestDateObj.getMonth();
                    const latestYear = latestDateObj.getFullYear();

                    const prevMonth = latestMonth === 0 ? 11 : latestMonth - 1;
                    const prevYear = latestMonth === 0 ? latestYear - 1 : latestYear;
                    const prevMonthYearMonth = `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}`;
                    const prevMonthEntry = data.find(entry => entry.date.slice(0, 7) === prevMonthYearMonth);
                    const prevMonthValue = prevMonthEntry ? prevMonthEntry.value / 1000 : null;

                    const prevYearDate = new Date(latestDateObj);
                    prevYearDate.setFullYear(prevYearDate.getFullYear() - 1);
                    const prevYearYearMonth = prevYearDate.toISOString().slice(0, 7);
                    const prevYearEntry = data.find(entry => entry.date.slice(0, 7) === prevYearYearMonth);
                    const prevYearValue = prevYearEntry ? prevYearEntry.value / 1000 : null;

                    let mmChange = null, mmPercent = null, rrChange = null, rrPercent = null;
                    if (prevMonthValue !== null) {
                        mmChange = latestValue - prevMonthValue;
                        mmPercent = (mmChange / prevMonthValue) * 100;
                    }
                    if (prevYearValue !== null) {
                        rrChange = latestValue - prevYearValue;
                        rrPercent = (rrChange / prevYearValue) * 100;
                    }

                    return {
                        value: latestValue,
                        share: m3Total ? (latestValue / m3Total * 100) : null,
                        mmChange,
                        mmPercent,
                        rrChange,
                        rrPercent
                    };
                };

                const latestDateObj = columns.m3 && columns.m3.data.length > 0 ? new Date(columns.m3.data[columns.m3.data.length - 1].date) : new Date();

                // M1
                const m1Metrics = calculateMetrics(columns.m1, latestDateObj);
                tableData.push({
                    id: 'm1',
                    name: 'Pieniądz M1',
                    category: 'm1',
                    metrics: m1Metrics,
                    subcategories: [
                        {
                            id: 'cash_outside_mif',
                            name: 'Pieniądz gotówkowy w obiegu (poza kasami MIF)',
                            metrics: calculateMetrics(columns.cash_outside_mif, latestDateObj)
                        },
                        {
                            id: 'deposits_current',
                            name: 'Depozyty i inne zobowiązania bieżące',
                            metrics: calculateMetrics(columns.deposits_current, latestDateObj),
                            subcategories: [
                                { id: 'households_current', name: 'Gospodarstwa domowe', metrics: calculateMetrics(columns.households_current, latestDateObj) },
                                { id: 'other_fin_current', name: 'Pozostałe instytucje finansowe', metrics: calculateMetrics(columns.other_fin_current, latestDateObj) },
                                { id: 'nonfin_current', name: 'Przedsiębiorstwa niefinansowe', metrics: calculateMetrics(columns.nonfin_current, latestDateObj) },
                                { id: 'nonprofit_current', name: 'Instytucje niekomercyjne działające na rzecz gospodarstw domowych', metrics: calculateMetrics(columns.nonprofit_current, latestDateObj) },
                                { id: 'localgov_current', name: 'Instytucje samorządowe', metrics: calculateMetrics(columns.localgov_current, latestDateObj) },
                                { id: 'social_funds_current', name: 'Fundusze zabezpieczenia społecznego', metrics: calculateMetrics(columns.social_funds_current, latestDateObj) }
                            ]
                        }
                    ]
                });

                // M2
                const m2Metrics = calculateMetrics(columns.m2, latestDateObj);
                tableData.push({
                    id: 'm2',
                    name: 'Pieniądz M2',
                    category: 'm2',
                    metrics: m2Metrics,
                    subcategories: [
                        { id: 'm1', name: 'Pieniądz M1', metrics: m1Metrics, reference: true },
                        {
                            id: 'deposits_2y',
                            name: 'Depozyty i inne zobowiązania do 2 lat włącznie',
                            metrics: calculateMetrics(columns.deposits_2y, latestDateObj),
                            subcategories: [
                                { id: 'households_2y', name: 'Gospodarstwa domowe', metrics: calculateMetrics(columns.households_2y, latestDateObj) },
                                { id: 'other_fin_2y', name: 'Pozostałe instytucje finansowe', metrics: calculateMetrics(columns.other_fin_2y, latestDateObj) },
                                { id: 'nonfin_2y', name: 'Przedsiębiorstwa niefinansowe', metrics: calculateMetrics(columns.nonfin_2y, latestDateObj) },
                                { id: 'nonprofit_2y', name: 'Instytucje niekomercyjne działające na rzecz gospodarstw domowych', metrics: calculateMetrics(columns.nonprofit_2y, latestDateObj) },
                                { id: 'localgov_2y', name: 'Instytucje samorządowe', metrics: calculateMetrics(columns.localgov_2y, latestDateObj) },
                                { id: 'social_funds_2y', name: 'Fundusze zabezpieczenia społecznego', metrics: calculateMetrics(columns.social_funds_2y, latestDateObj) }
                            ]
                        }
                    ]
                });

                // M3
                const m3Metrics = calculateMetrics(columns.m3, latestDateObj);
                tableData.push({
                    id: 'm3',
                    name: 'Pieniądz M3',
                    category: 'm3',
                    metrics: m3Metrics,
                    subcategories: [
                        { id: 'm2', name: 'Pieniądz M2', metrics: m2Metrics, reference: true },
                        { id: 'repo_operations', name: 'Operacje z przyrzeczeniem odkupu', metrics: calculateMetrics(columns.repo_operations, latestDateObj) },
                        { id: 'debt_securities_2y', name: 'Emisja dłużnych papierów wartościowych z terminem pierwotnym do 2 lat', metrics: calculateMetrics(columns.debt_securities_2y, latestDateObj) },
                        { id: 'money_market_funds', name: 'Emisja udziałów/jednostek uczestnictwa w funduszach rynku pieniężnego', metrics: calculateMetrics(columns.money_market_funds, latestDateObj) }
                    ]
                });

                // Funkcja formatowania wartości
                const formatValue = (value, type = 'value') => {
                    if (value === null) return '<span class="neutral">Brak danych</span>';
                    if (type === 'value') return value.toFixed(2);
                    if (type === 'share') return value.toFixed(2) + '%';
                    if (type === 'change') {
                        return `<span class="${value >= 0 ? 'positive' : value < 0 ? 'negative' : 'neutral'}">${value >= 0 ? '+' : ''}${value.toFixed(2)}</span>`;
                    }
                    if (type === 'percent') {
                        return `<span class="${value >= 0 ? 'positive' : value < 0 ? 'negative' : 'neutral'}">${value >= 0 ? '+' : ''}${value.toFixed(2)}%</span>`;
                    }
                };

                // Renderowanie tabeli
                const tableBody = document.querySelector('#m3-table tbody');
                const renderTable = (data) => {
                    tableBody.innerHTML = '';
                    
                    // Znajdź M3 i sortuj jego podkategorie
                    const m3Item = data.find(item => item.id === 'm3');
                    if (!m3Item) return; // Jeśli nie ma M3, kończymy
                    
                    // Funkcja do sortowania elementów według wartości
                    const sortByValue = (items) => {
                        return [...items].sort((a, b) => {
                            if (a.metrics.value === null) return 1;
                            if (b.metrics.value === null) return -1;
                            return b.metrics.value - a.metrics.value;
                        });
                    };
                    
                    // Śledź już wyrenderowane elementy
                    const renderedItems = {};
                    
                    // Główna funkcja renderująca wiersze
                    const createRow = (item, level = 0, isVisible = true, parentCategory = null) => {
                        // Nie renderuj dwa razy tego samego elementu (referencje)
                        if (renderedItems[item.id]) return;
                        renderedItems[item.id] = true;
                        
                        // Ustal kategorię wiersza (dla kolorowych pasków)
                        // Jeśli element ma własną kategorię, użyj jej
                        // W przeciwnym razie dziedzicz kategorię od rodzica
                        const rowCategory = item.category || parentCategory;
                        
                        const row = document.createElement('tr');
                        row.className = `${level > 0 ? 'subcategory-row' : 'category-row'} ${rowCategory ? rowCategory + '-row' : ''}`;
                        row.dataset.id = item.id;
                        row.dataset.level = level;
                        
                        // Ukryj element, jeśli nie powinien być widoczny
                        if (!isVisible) {
                            row.classList.add('hidden');
                        }
                        
                        // Określ, czy element ma dzieci do rozwijania
                        const hasToggle = item.subcategories && item.subcategories.length > 0 && !item.reference;
                        
                        // Dodaj ikonę rozwijania (lub spacer)
                        let toggleHTML = '';
                        if (hasToggle) {
                            toggleHTML = '<span class="toggle-icon">▶</span>';
                        } else {
                            toggleHTML = '<span style="display:inline-block;width:20px;"></span>';
                        }
                        
                        // Nie używaj inline stylów dla wcięć, korzystaj z atrybutu data-level
                        row.innerHTML = `
                            <td>${toggleHTML}${item.name}</td>
                            <td>${formatValue(item.metrics.value)}</td>
                            <td>${formatValue(item.metrics.share, 'share')}</td>
                            <td>${formatValue(item.metrics.mmChange, 'change')}</td>
                            <td>${formatValue(item.metrics.mmPercent, 'percent')}</td>
                            <td>${formatValue(item.metrics.rrChange, 'change')}</td>
                            <td>${formatValue(item.metrics.rrPercent, 'percent')}</td>
                        `;
                        
                        tableBody.appendChild(row);
                        
                        // Dodaj obsługę kliknięcia na ikonę rozwijania
                        if (hasToggle) {
                            const icon = row.querySelector('.toggle-icon');
                            icon.addEventListener('click', () => {
                                const isExpanded = icon.classList.toggle('expanded');
                                
                                // Dla każdego bezpośredniego dziecka
                                if (item.subcategories) {
                                    item.subcategories.forEach(subItem => {
                                        // Znajdź wiersz odpowiadający dziecku
                                        const childRow = document.querySelector(`tr[data-id="${subItem.id}"]`);
                                        if (childRow) {
                                            // Pokaż/ukryj dziecko
                                            childRow.classList.toggle('hidden', !isExpanded);
                                            
                                            // Jeśli zwijamy, zwijamy też wszystkie dzieci
                                            if (!isExpanded) {
                                                // Znajdź wszystkie rozwinięte ikony wśród dzieci
                                                const expandedIcons = childRow.querySelectorAll('.toggle-icon.expanded');
                                                expandedIcons.forEach(expandedIcon => {
                                                    expandedIcon.click(); // Symuluj kliknięcie, aby zwinąć
                                                });
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    };
                    
                    // 1. Najpierw renderuj M3 (zawsze widoczny)
                    createRow(m3Item, 0, true);
                    
                    // 2. Znajdź i renderuj M2 (bezpośrednie dziecko M3, widoczne)
                    const m2Item = m3Item.subcategories.find(item => item.id === 'm2');
                    if (m2Item) {
                        createRow(m2Item, 1, true, 'm2');  // przekaż 'm2' jako kategorię rodzica
                    }
                    
                    // 3. Znajdź M1 (bezpośrednie dziecko M2 lub M3, widoczne)
                    let m1Item = null;
                    if (m2Item && m2Item.subcategories) {
                        m1Item = m2Item.subcategories.find(item => item.id === 'm1');
                        if (m1Item) {
                            createRow(m1Item, 1, true, 'm1');  // przekaż 'm1' jako kategorię rodzica
                        }
                    }
                    
                    // 4. Renderuj inne bezpośrednie dzieci M3 (sortowane po wartości, widoczne)
                    const otherM3Children = m3Item.subcategories.filter(item => item.id !== 'm2' && item.id !== 'm1');
                    const sortedM3Children = sortByValue(otherM3Children);
                    sortedM3Children.forEach(child => {
                        createRow(child, 1, true, 'm3');  // przekaż 'm3' jako kategorię rodzica
                    });
                    
                    // 5. Renderuj dzieci M2 (ukryte dopóki M2 nie zostanie rozwinięte)
                    if (m2Item && m2Item.subcategories) {
                        // Renderuj pozostałe dzieci M2 (sortowane po wartości)
                        const otherM2Children = m2Item.subcategories.filter(item => item.id !== 'm1');
                        const sortedM2Children = sortByValue(otherM2Children);
                        sortedM2Children.forEach(child => {
                            createRow(child, 2, false, 'm2');  // przekaż 'm2' jako kategorię rodzica
                            
                            // Renderuj dzieci tych elementów
                            if (child.subcategories) {
                                const sortedGrandchildren = sortByValue(child.subcategories);
                                sortedGrandchildren.forEach(grandchild => {
                                    createRow(grandchild, 3, false, 'm2');  // zachowaj kategorię rodzica
                                });
                            }
                        });
                    }
                    
                    // 6. Renderuj dzieci M1 (jeszcze głębszy poziom, także ukryte)
                    if (m1Item && m1Item.subcategories) {
                        const sortedM1Children = sortByValue(m1Item.subcategories);
                        sortedM1Children.forEach(child => {
                            createRow(child, 2, false, 'm1');  // przekaż 'm1' jako kategorię rodzica
                            
                            // Jeśli dziecko M1 ma dalsze dzieci, też je renderuj
                            if (child.subcategories) {
                                const sortedGrandchildren = sortByValue(child.subcategories);
                                sortedGrandchildren.forEach(grandchild => {
                                    createRow(grandchild, 3, false, 'm1');  // zachowaj kategorię rodzica
                                });
                            }
                        });
                    }
                    
                    // 7. Renderuj dzieci pozostałych kategorii (ukryte)
                    sortedM3Children.forEach(child => {
                        if (child.subcategories) {
                            const sortedChildren = sortByValue(child.subcategories);
                            sortedChildren.forEach(grandchild => {
                                createRow(grandchild, 2, false, 'm3');  // przekaż 'm3' jako kategorię rodzica
                            });
                        }
                    });
                };

                // Wywołanie początkowe
                renderTable(tableData);

                // Oblicz zmiany dla wykresu zmian
                const calculateChanges = (period, unit) => {
                    const changes = { m3: [], m2: [], m1: [] };
                    for (const key of ['m3', 'm2', 'm1']) {
                        if (!columns[key]) {
                            changes[key] = new Array(dates.length).fill(null);
                            continue;
                        }
                        const data = columns[key].data;
                        for (let i = 0; i < data.length; i++) {
                            const [year, month, day] = data[i].date.split("-").map(Number);
                            const currentDate = new Date(Date.UTC(year, month - 1, day));
                            const currentValue = data[i].value / 1000;
                            let prevValue = null;
                            if (period === 'rr') {
                                const prevYearDate = new Date(currentDate);
                                prevYearDate.setFullYear(prevYearDate.getFullYear() - 1);
                                const prevYearMonth = `${prevYearDate.getUTCFullYear()}-${String(prevYearDate.getUTCMonth() + 1).padStart(2, '0')}`;
                                const prevEntry = data.find(entry => entry.date.slice(0, 7) === prevYearMonth);
                                prevValue = prevEntry ? prevEntry.value / 1000 : null;
                            } else {
                                const currentMonth = currentDate.getUTCMonth();
                                const currentYear = currentDate.getUTCFullYear();
                                const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                                const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                                const prevMonthMonth = `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}`;
                                const prevEntry = data.find(entry => entry.date.slice(0, 7) === prevMonthMonth);
                                prevValue = prevEntry ? prevEntry.value / 1000 : null;
                            }
                            if (prevValue !== null) {
                                const change = currentValue - prevValue;
                                changes[key][i] = unit === 'percent' ? (change / prevValue * 100) : change;
                            } else {
                                changes[key][i] = null;
                            }
                        }
                    }
                    return changes;
                };

                // Wykres wartości
                const valuesChartOptions = {
                    chart: {
                        id: 'valueChart',
                        type: 'area',
                        height: 400,
                        fontFamily: 'Poppins, sans-serif',
                        zoom: {
                            enabled: false
                        },
                        toolbar: {
                            show: true,
                            tools: {
                                download: false,
                                selection: false,
                                zoom: false,
                                zoomin: false,
                                zoomout: false,
                                pan: false,
                                reset: true
                            }
                        }
                    },
                    series: [
                        { name: 'M3', data: valuesData.m3, color: '#9f7aea' },
                        { name: 'M2', data: valuesData.m2, color: '#4299e1' },
                        { name: 'M1', data: valuesData.m1, color: '#48bb78' }
                    ],
                    xaxis: {
                        type: 'datetime',
                        categories: dates,
                        labels: { format: 'yyyy-MM' }
                    },
                    yaxis: {
                        title: { text: 'Wartość (mld PLN)' },
                        labels: { formatter: val => val.toFixed(2) },
                        forceNiceScale: true
                    },
                    stroke: {
                        curve: 'smooth',
                        width: 2
                    },
                    fill: {
                        opacity: 0.3,
                        type: 'gradient',
                        gradient: {
                            shadeIntensity: 1,
                            opacityFrom: 0.7,
                            opacityTo: 0.2
                        }
                    },
                    dataLabels: {
                        enabled: false
                    },
                    markers: {
                        size: 0,
                        hover: {
                            size: 5
                        }
                    },
                    tooltip: {
                        x: { format: 'yyyy-MM-dd' },
                        y: { formatter: val => val ? `${val.toFixed(2)} mld PLN` : 'Brak danych' },
                        shared: true,
                        intersect: false
                    },
                    legend: {
                        position: 'top',
                        horizontalAlign: 'center'
                    }
                };

                const valuesBrushOptions = {
                    chart: {
                        id: 'brushChartValues',
                        height: 130,
                        type: 'area',
                        brush: {
                            enabled: true,
                            target: 'valueChart'
                        },
                        selection: {
                            enabled: true,
                            xaxis: {
                                min: dates.length > 120 ? dates[dates.length - 120] : dates[0],
                                max: dates[dates.length - 1]
                            }
                        }
                    },
                    colors: ['#9f7aea', '#4299e1', '#48bb78'],
                    series: [
                        { name: 'M3', data: valuesData.m3 },
                        { name: 'M2', data: valuesData.m2 },
                        { name: 'M1', data: valuesData.m1 }
                    ],
                    xaxis: {
                        type: 'datetime',
                        categories: dates,
                        labels: { format: 'yyyy-MM' },
                        tooltip: {
                            enabled: false
                        }
                    },
                    yaxis: {
                        tickAmount: 2,
                        labels: {
                            show: false
                        }
                    },
                    legend: {
                        show: false
                    },
                    fill: {
                        opacity: 0.1
                    },
                    stroke: {
                        width: 1
                    }
                };

                let valuesChart = new ApexCharts(document.querySelector('#values-chart'), valuesChartOptions);
                valuesChart.render();

                // Warunkowa inicjalizacja wykresów brush
                let valuesBrushChart, changesBrushChart;
                let changesChart = new ApexCharts(document.querySelector('#changes-chart'), {
                    chart: {
                        id: 'changesChart',
                        type: 'area',
                        height: 400,
                        fontFamily: 'Poppins, sans-serif',
                        zoom: {
                            enabled: false
                        },
                        toolbar: {
                            show: true,
                            tools: {
                                download: false,
                                selection: false,
                                zoom: false,
                                zoomin: false,
                                zoomout: false,
                                pan: false,
                                reset: true
                            }
                        }
                    },
                    series: [],
                    xaxis: {
                        type: 'datetime',
                        categories: dates,
                        labels: { format: 'yyyy-MM' }
                    },
                    stroke: { curve: 'smooth', width: 2 },
                    fill: {
                        opacity: 0.2,
                        type: 'gradient',
                        gradient: {
                            shadeIntensity: 1,
                            opacityFrom: 0.5,
                            opacityTo: 0.1
                        }
                    },
                    dataLabels: {
                        enabled: false
                    },
                    markers: {
                        size: 0,
                        hover: {
                            size: 5
                        }
                    },
                    tooltip: {
                        x: { format: 'yyyy-MM-dd' },
                        y: { formatter: val => val ? `${val.toFixed(2)} ${currentUnit === 'percent' ? '%' : 'mld PLN'}` : 'Brak danych' },
                        shared: true,
                        intersect: false
                    },
                    legend: { position: 'top' }
                });
                changesChart.render();

                let currentPeriod = 'rr';
                let currentUnit = 'mld';

                // Definicja updateChangesChart przed użyciem
                const updateChangesChart = () => {
                    if (!changesChart) return;
                    
                    const changes = calculateChanges(currentPeriod, currentUnit);
                    changesChart.updateSeries([
                        { name: 'M3', data: changes.m3, color: '#9f7aea' },
                        { name: 'M2', data: changes.m2, color: '#4299e1' },
                        { name: 'M1', data: changes.m1, color: '#48bb78' }
                    ]);
                    changesChart.updateOptions({
                        yaxis: {
                            title: { text: currentUnit === 'percent' ? 'Zmiana (%)' : 'Zmiana (mld PLN)' },
                            labels: { formatter: val => val ? val.toFixed(2) : '' },
                            forceNiceScale: true
                        },
                        tooltip: {
                            x: { format: 'yyyy-MM-dd' },
                            y: { formatter: val => val ? `${val.toFixed(2)} ${currentUnit === 'percent' ? '%' : 'mld PLN'}` : 'Brak danych' },
                            shared: true,
                            intersect: false
                        }
                    });
                    if (changesBrushChart) {
                        changesBrushChart.updateSeries([
                            { name: 'M3', data: changes.m3, color: '#9f7aea' },
                            { name: 'M2', data: changes.m2, color: '#4299e1' },
                            { name: 'M1', data: changes.m1, color: '#48bb78' }
                        ]);
                    }
                };

                if (!isMobileDevice()) {
                    valuesBrushChart = new ApexCharts(document.querySelector('#brush-chart-values'), valuesBrushOptions);
                    valuesBrushChart.render();
                    
                    changesBrushChart = new ApexCharts(document.querySelector('#brush-chart-changes'), {
                        chart: {
                            id: 'brushChartChanges',
                            height: 130,
                            type: 'area',
                            brush: {
                                enabled: true,
                                target: 'changesChart'
                            },
                            selection: {
                                enabled: true,
                                xaxis: {
                                    min: dates.length > 120 ? dates[dates.length - 120] : dates[0],
                                    max: dates[dates.length - 1]
                                }
                            }
                        },
                        colors: ['#9f7aea', '#4299e1', '#48bb78'],
                        series: [],
                        xaxis: {
                            type: 'datetime',
                            categories: dates,
                            labels: { format: 'yyyy-MM' },
                            tooltip: {
                                enabled: false
                            }
                        },
                        yaxis: {
                            tickAmount: 2,
                            labels: {
                                show: false
                            }
                        },
                        legend: {
                            show: false
                        },
                        fill: {
                            opacity: 0.1
                        },
                        stroke: {
                            width: 1
                        }
                    });
                    changesBrushChart.render();
                    updateChangesChart();
                } else {
                    console.log("Wykryto urządzenie mobilne - tworzenie nowych wykresów z konfiguracją zoomable timeseries");
                    
                    // Ukryj elementy brush chart
                    document.getElementById('brush-chart-values').style.display = 'none';
                    document.getElementById('brush-chart-changes').style.display = 'none';
                    
                    // Zniszcz istniejące wykresy
                    valuesChart.destroy();
                    changesChart.destroy();
                    
                    // Konfiguracja dla wykresu wartości
                    const mobileValuesOptions = {
                        series: [
                            { name: 'M3', data: valuesData.m3, color: '#9f7aea' },
                            { name: 'M2', data: valuesData.m2, color: '#4299e1' },
                            { name: 'M1', data: valuesData.m1, color: '#48bb78' }
                        ],
                        chart: {
                            type: 'area',
                            stacked: false,
                            height: 400,
                            fontFamily: 'Poppins, sans-serif',
                            zoom: {
                                type: 'x',
                                enabled: true,
                                autoScaleYaxis: true,
                                zoomedArea: {
                                    fill: { color: '#90CAF9', opacity: 0.4 },
                                    stroke: { color: '#0D47A1', opacity: 0.4, width: 1 }
                                }
                            },
                            toolbar: {
                                autoSelected: 'zoom',
                                tools: {
                                    download: false,
                                    selection: true,
                                    zoom: true,
                                    zoomin: false,
                                    zoomout: false,
                                    pan: true,
                                    reset: true
                                }
                            },
                            events: {
                                beforeResetZoom: function(chartContext, opts) {
                                    console.log('Przycisk reset - pokazywanie pełnej historii');
                                    setTimeout(() => {
                                        valuesChart.updateOptions({
                                            xaxis: {
                                                min: dates[0],
                                                max: dates[dates.length - 1]
                                            }
                                        });
                                        changesChart.updateOptions({
                                            xaxis: {
                                                min: dates[0],
                                                max: dates[dates.length - 1]
                                            }
                                        });
                                    }, 10);
                                    return false;
                                }
                            }
                        },
                        dataLabels: {
                            enabled: false
                        },
                        markers: {
                            size: 0,
                            hover: {
                                size: 5
                            }
                        },
                        stroke: {
                            curve: 'smooth',
                            width: 2
                        },
                        fill: {
                            type: 'gradient',
                            gradient: {
                                shadeIntensity: 1,
                                opacityFrom: 0.7,
                                opacityTo: 0.2,
                                stops: [0, 90, 100]
                            }
                        },
                        xaxis: {
                            type: 'datetime',
                            categories: dates,
                            labels: { format: 'yyyy-MM' }
                        },
                        yaxis: {
                            title: { text: 'Wartość (mld PLN)' },
                            labels: { formatter: val => val.toFixed(2) },
                            forceNiceScale: true
                        },
                        tooltip: {
                            shared: true,
                            intersect: false,
                            x: { format: 'yyyy-MM-dd' },
                            y: {
                                formatter: function (val) {
                                    return val ? val.toFixed(2) + " mld PLN" : "Brak danych";
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            horizontalAlign: 'center'
                        }
                    };
                    
                    // Utworzenie nowego wykresu wartości
                    valuesChart = new ApexCharts(document.querySelector('#values-chart'), mobileValuesOptions);
                    valuesChart.render();
                    
                    // Konfiguracja dla wykresu zmian
                    const mobileChangesOptions = {
                        series: [],
                        chart: {
                            type: 'area',
                            stacked: false,
                            height: 400,
                            fontFamily: 'Poppins, sans-serif',
                            zoom: {
                                type: 'x',
                                enabled: true,
                                autoScaleYaxis: true,
                                zoomedArea: {
                                    fill: { color: '#90CAF9', opacity: 0.4 },
                                    stroke: { color: '#0D47A1', opacity: 0.4, width: 1 }
                                }
                            },
                            toolbar: {
                                autoSelected: 'zoom',
                                tools: {
                                    download: false,
                                    selection: true,
                                    zoom: true,
                                    zoomin: false,
                                    zoomout: false,
                                    pan: true,
                                    reset: true
                                }
                            },
                            events: {
                                beforeResetZoom: function(chartContext, opts) {
                                    return false; // Wykres wartości już obsłuży resetowanie obu wykresów
                                }
                            }
                        },
                        dataLabels: {
                            enabled: false
                        },
                        markers: {
                            size: 0,
                            hover: {
                                size: 5
                            }
                        },
                        stroke: {
                            curve: 'smooth',
                            width: 2
                        },
                        fill: {
                            type: 'gradient',
                            gradient: {
                                shadeIntensity: 1,
                                opacityFrom: 0.5,
                                opacityTo: 0.1,
                                stops: [0, 90, 100]
                            }
                        },
                        xaxis: {
                            type: 'datetime',
                            categories: dates,
                            labels: { format: 'yyyy-MM' }
                        },
                        yaxis: {
                            title: { text: currentUnit === 'percent' ? 'Zmiana (%)' : 'Zmiana (mld PLN)' },
                            labels: { formatter: val => val ? val.toFixed(2) : '' },
                            forceNiceScale: true
                        },
                        tooltip: {
                            shared: true,
                            intersect: false,
                            x: { format: 'yyyy-MM-dd' },
                            y: {
                                formatter: function (val) {
                                    return val ? `${val.toFixed(2)} ${currentUnit === 'percent' ? '%' : 'mld PLN'}` : 'Brak danych';
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            horizontalAlign: 'center'
                        }
                    };
                    
                    // Utworzenie nowego wykresu zmian
                    changesChart = new ApexCharts(document.querySelector('#changes-chart'), mobileChangesOptions);
                    changesChart.render();
                    
                    // Dodanie początkowych danych do wykresu zmian
                    updateChangesChart();
                    
                    // Ustaw domyślny zakres 5 lat
                    const defaultMonths = Math.min(60, dates.length - 1);
                    if (defaultMonths > 0) {
                        const minDate = dates[dates.length - defaultMonths - 1];
                        const maxDate = dates[dates.length - 1];
                        valuesChart.updateOptions({ xaxis: { min: minDate, max: maxDate } });
                        changesChart.updateOptions({ xaxis: { min: minDate, max: maxDate } });
                    }
                    
                    // Nasłuchiwanie kliknięcia przycisku reset
                    setTimeout(() => {
                        const resetButtons = document.querySelectorAll('.apexcharts-reset-icon');
                        resetButtons.forEach(button => {
                            button.addEventListener('click', function(e) {
                                console.log('Przycisk reset kliknięty ręcznie');
                                setTimeout(() => {
                                    valuesChart.updateOptions({
                                        xaxis: {
                                            min: dates[0],
                                            max: dates[dates.length - 1]
                                        }
                                    });
                                    changesChart.updateOptions({
                                        xaxis: {
                                            min: dates[0],
                                            max: dates[dates.length - 1]
                                        }
                                    });
                                }, 50);
                            });
                        });
                    }, 500);
                }

                document.getElementById('period-toggle').addEventListener('change', (e) => {
                    currentPeriod = e.target.checked ? 'rr' : 'mm';
                    updateChangesChart();
                });

                document.getElementById('unit-toggle').addEventListener('change', (e) => {
                    currentUnit = e.target.checked ? 'mld' : 'percent';
                    updateChangesChart();
                });

                // Debugowanie zdarzeń zooma i zaznaczania
                valuesChart.addEventListener('zoomed', function(chartContext, { xaxis, yaxis }) {
                    console.log('Zdarzenie zoom wywołane', xaxis, yaxis);
                });

                valuesChart.addEventListener('selection', function(chartContext, { xaxis, yaxis }) {
                    console.log('Zdarzenie selection wywołane', xaxis, yaxis);
                });
            } catch (error) {
                console.error('Błąd:', error);
                for (const key of ['m3', 'm2', 'm1']) {
                    document.getElementById(`${key}-value`).textContent = 'Błąd ładowania';
                    document.getElementById(`${key}-mm`).textContent = 'Błąd';
                    document.getElementById(`${key}-rr`).textContent = 'Błąd';
                    document.getElementById(`${key}-date`).textContent = 'Błąd';
                    document.getElementById(`${key}-text`).textContent = `Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.`;
                }
                document.querySelector('#values-chart').innerHTML = '<p>Błąd ładowania wykresu</p>';
                document.querySelector('#changes-chart').innerHTML = '<p>Błąd ładowania wykresu</p>';
                document.querySelector('#brush-chart-values').innerHTML = '';
                document.querySelector('#brush-chart-changes').innerHTML = '';
                document.querySelector('#m3-table tbody').innerHTML = '<tr><td colspan="7">Błąd ładowania danych</td></tr>';
            }
        }

        window.onload = loadData;
    </script>
</body>
</html>
