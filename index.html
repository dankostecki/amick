<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podaż Pieniądza w Polsce</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f4f7fa;
            margin: 0;
            padding: 0;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        h1, h2 {
            text-align: center;
            color: #1a3c5e;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 50px;
        }
        h2 {
            font-size: 2rem;
            margin: 40px 0 30px;
        }
        .columns {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .column-container {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
        }
        .column {
            background: linear-gradient(135deg, #ffffff, #e8eff5);
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            text-align: center;
            transition: transform 0.3s ease;
            border-top: 5px solid transparent;
        }
        .m3-column {
            border-top-color: #9f7aea;
        }
        .m2-column {
            border-top-color: #4299e1;
        }
        .m1-column {
            border-top-color: #48bb78;
        }
        .column:hover {
            transform: translateY(-5px);
        }
        .column h2 {
            font-size: 3.5rem;
            font-weight: 700;
            margin: 0 0 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.15);
            display: inline-block;
        }
        .m3-header {
            background: linear-gradient(135deg, #6b46c1, #9f7aea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .m2-header {
            background: linear-gradient(135deg, #2b6cb0, #4299e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .m1-header {
            background: linear-gradient(135deg, #2f855a, #48bb78);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .value {
            font-size: 2rem;
            font-weight: 600;
            color: #2c5282;
            margin: 10px 0;
        }
        .change {
            font-size: 1.1rem;
            margin: 5px 0;
        }
        .positive {
            color: #28a745;
        }
        .negative {
            color: #dc3545;
        }
        .date-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
        }
        .text-box {
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-top: 20px;
            text-align: left;
        }
        .text-content {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        .charts-section {
            margin-top: 60px;
        }
        .chart-columns {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        .chart-column {
            flex: 1;
            min-width: 300px;
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .toggles {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 20px;
        }
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toggle-label {
            font-size: 0.9rem;
            color: #333;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 20px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #4299e1;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        #brush-chart-values, #brush-chart-changes {
            margin-top: -10px;
            margin-bottom: 20px;
        }
        .apexcharts-selection-rect, 
        .apexcharts-svg rect.apexcharts-zoom-rect, 
        .apexcharts-svg rect.apexcharts-selection-rect {
            cursor: move;
        }
        @media (max-width: 768px) {
            .apexcharts-zoom-icon,
            .apexcharts-selection-icon,
            .apexcharts-pan-icon,
            .apexcharts-reset-icon {
                transform: scale(1.5);
                margin: 0 8px;
            }
            #brush-chart-values, #brush-chart-changes {
                height: 160px !important;
            }
            .apexcharts-selection-rect .apexcharts-selection-rect-handle {
                width: 20px !important;
                height: 20px !important;
                transform: translate(-50%, -50%);
            }
        }
        @media (max-width: 768px) {
            .columns, .chart-columns {
                flex-direction: column;
                align-items: center;
            }
            .column-container, .chart-column {
                width: 100%;
                max-width: 400px;
            }
            .toggles {
                flex-direction: column;
                align-items: center;
            }
        }
        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5);
        }
        /* Tree-table styles */
        .tree-table-section {
            margin-top: 60px;
        }
        .tree-table-container {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            padding: 24px;
            overflow-x: auto;
        }
        .tree-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1rem;
        }
        .tree-table th {
            background: linear-gradient(135deg, #1a3c5e, #4299e1);
            color: #fff;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
        }
        .tree-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
        }
        .tree-indent-0 { padding-left: 0; }
        .tree-indent-1 { padding-left: 20px; }
        .tree-indent-2 { padding-left: 40px; }
        .tree-indent-3 { padding-left: 60px; }
        .tree-indent-4 { padding-left: 80px; }
        .positive-value { color: #28a745; font-weight: 600; }
        .negative-value { color: #dc3545; font-weight: 600; }
        @media (max-width: 768px) {
            .tree-table { font-size: 0.85rem; }
            .tree-table-container { padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Podaż Pieniądza w Polsce</h1>
        <!-- Karty agregatów -->
        <div class="columns">
            <div class="column-container">
                <div class="column m3-column">
                    <h2 class="m3-header">M3</h2>
                    <div class="value" id="m3-value">Ładowanie...</div>
                    <div class="change" id="m3-mm">Ładowanie...</div>
                    <div class="change" id="m3-rr">Ładowanie...</div>
                    <div class="date-info" id="m3-date">Ładowanie...</div>
                </div>
                <div class="text-box">
                    <div class="text-content" id="m3-text">
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                    </div>
                </div>
            </div>
            <div class="column-container">
                <div class="column m2-column">
                    <h2 class="m2-header">M2</h2>
                    <div class="value" id="m2-value">Ładowanie...</div>
                    <div class="change" id="m2-mm">Ładowanie...</div>
                    <div class="change" id="m2-rr">Ładowanie...</div>
                    <div class="date-info" id="m2-date">Ładowanie...</div>
                </div>
                <div class="text-box">
                    <div class="text-content" id="m2-text">
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                    </div>
                </div>
            </div>
            <div class="column-container">
                <div class="column m1-column">
                    <h2 class="m1-header">M1</h2>
                    <div class="value" id="m1-value">Ładowanie...</div>
                    <div class="change" id="m1-mm">Ładowanie...</div>
                    <div class="change" id="m1-rr">Ładowanie...</div>
                    <div class="date-info" id="m1-date">Ładowanie...</div>
                </div>
                <div class="text-box">
                    <div class="text-content" id="m1-text">
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                    </div>
                </div>
            </div>
        </div>
        <!-- Wykresy agregatów -->
        <section class="charts-section">
            <h2>Wykres skumulowany</h2>
            <div class="chart-columns">
                <div class="chart-column">
                    <div id="values-chart"></div>
                    <div id="brush-chart-values"></div>
                </div>
                <div class="chart-column">
                    <div class="toggles">
                        <div class="toggle-container">
                            <span class="toggle-label">r/r</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="period-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">m/m</span>
                        </div>
                        <div class="toggle-container">
                            <span class="toggle-label">mld PLN</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="unit-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">%</span>
                        </div>
                    </div>
                    <div id="changes-chart"></div>
                    <div id="brush-chart-changes"></div>
                </div>
            </div>
        </section>
        <!-- NOWA SEKCJA: Tabela drzewkowa -->
        <section class="tree-table-section">
            <h2>Struktura Agregatów Pieniężnych (drzewko)</h2>
            <div class="tree-table-container">
                <table class="tree-table">
                    <thead>
                        <tr>
                            <th>Agregaty pieniężne</th>
                            <th>Wartość (mld PLN)</th>
                            <th>Zmiana r/r (mld)</th>
                            <th>Zmiana m/m (mld)</th>
                            <th>Zmiana r/r (%)</th>
                            <th>Zmiana m/m (%)</th>
                        </tr>
                    </thead>
                    <tbody id="tree-table-body">
                        <!-- Wiersze będą wygenerowane przez JS -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>
    <script>
        // ...Wszystkie wcześniejsze funkcje do kart i wykresów, w uproszczeniu:
        function isMobileDevice() {
            return window.innerWidth <= 768;
        }
        async function loadData() {
            try {
                const response = await fetch('am_data.json');
                if (!response.ok) throw new Error('Błąd pobierania danych');
                const jsonData = await response.json();
                if (!jsonData.columns || !Array.isArray(jsonData.columns)) throw new Error('Błąd struktury JSON');
                const columns = {
                    m3: jsonData.columns.find(col => col.column_id === 23),
                    m2: jsonData.columns.find(col => col.column_id === 19),
                    m1: jsonData.columns.find(col => col.column_id === 11)
                };
                for (const [key, column] of Object.entries(columns)) {
                    if (!column) {
                        document.getElementById(`${key}-value`).textContent = 'Brak danych';
                        document.getElementById(`${key}-mm`).textContent = 'Brak danych';
                        document.getElementById(`${key}-rr`).textContent = 'Brak danych';
                        document.getElementById(`${key}-date`).textContent = 'Brak danych';
                        document.getElementById(`${key}-text`).textContent = '';
                        continue;
                    }
                    const data = column.data;
                    const latest = data[data.length - 1];
                    const latestValue = latest.value / 1000;
                    const latestDateObj = new Date(latest.date);
                    const latestMonth = latestDateObj.getMonth();
                    const latestYear = latestDateObj.getFullYear();
                    const prevMonth = latestMonth === 0 ? 11 : latestMonth - 1;
                    const prevYear = latestMonth === 0 ? latestYear - 1 : latestYear;
                    const prevMonthYearMonth = `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}`;
                    const prevMonthEntry = data.find(entry => entry.date.slice(0, 7) === prevMonthYearMonth);
                    const prevMonthValue = prevMonthEntry ? prevMonthEntry.value / 1000 : null;
                    const prevYearDate = new Date(latestDateObj);
                    prevYearDate.setFullYear(prevYearDate.getFullYear() - 1);
                    const prevYearYearMonth = prevYearDate.toISOString().slice(0, 7);
                    const prevYearEntry = data.find(entry => entry.date.slice(0, 7) === prevYearYearMonth);
                    const prevYearValue = prevYearEntry ? prevYearEntry.value / 1000 : null;
                    let mmChange = null, mmPercent = null, rrChange = null, rrPercent = null;
                    if (prevMonthValue !== null) {
                        mmChange = latestValue - prevMonthValue;
                        mmPercent = (mmChange / prevMonthValue) * 100;
                    }
                    if (prevYearValue !== null) {
                        rrChange = latestValue - prevYearValue;
                        rrPercent = (rrChange / prevYearValue) * 100;
                    }
                    document.getElementById(`${key}-value`).textContent = `${latestValue.toFixed(2)} mld PLN`;
                    document.getElementById(`${key}-mm`).textContent = prevMonthValue !== null
                        ? `${mmChange >= 0 ? '+' : ''}${mmChange.toFixed(2)} mld m/m (${mmPercent.toFixed(2)}%)`
                        : 'Brak danych m/m';
                    document.getElementById(`${key}-mm`).className = `change ${mmChange >= 0 ? 'positive' : 'negative'}`;
                    document.getElementById(`${key}-rr`).textContent = prevYearValue !== null
                        ? `${rrChange >= 0 ? '+' : ''}${rrChange.toFixed(2)} mld r/r (${rrPercent.toFixed(2)}%)`
                        : 'Brak danych r/r';
                    document.getElementById(`${key}-rr`).className = `change ${rrChange >= 0 ? 'positive' : 'negative'}`;
                    document.getElementById(`${key}-date`).textContent = `Stan na ${latest.date}, źródło: NBP`;
                    document.getElementById(`${key}-text`).textContent = '';
                }
                // Dalsza obsługa wykresów...
            } catch (error) {
                for (const key of ['m3', 'm2', 'm1']) {
                    document.getElementById(`${key}-value`).textContent = 'Błąd ładowania';
                    document.getElementById(`${key}-mm`).textContent = 'Błąd';
                    document.getElementById(`${key}-rr`).textContent = 'Błąd';
                    document.getElementById(`${key}-date`).textContent = 'Błąd';
                    document.getElementById(`${key}-text`).textContent = '';
                }
                document.querySelector('#values-chart').innerHTML = '<p>Błąd ładowania wykresu</p>';
                document.querySelector('#changes-chart').innerHTML = '<p>Błąd ładowania wykresu</p>';
                document.querySelector('#brush-chart-values').innerHTML = '';
                document.querySelector('#brush-chart-changes').innerHTML = '';
            }
        }

        // --- Drzewkowa struktura tabeli ---
        const treeStructure = [
            { name: "Pieniądz M3", level: 0, columnId: 23 },
            { name: "Dodatkowe komponenty M3", level: 1 },
            { name: "Operacje z przyrzeczeniem odkupu", level: 2, columnId: 20 },
            { name: "Emisja dłużnych papierów wartościowych z terminem pierwotnym do 2 lat (włącznie)", level: 2, columnId: 21 },
            { name: "Emisja udziałów / jednostek uczestnictwa w funduszach rynku pieniężnego", level: 2, columnId: 22 },
            { name: "Pieniądz M2", level: 1, columnId: 19 },
            { name: "Depozyty do 2 lat", level: 2, columnId: 12 },
            { name: "Gospodarstwa domowe (do 2 lat)", level: 3, columnId: 13 },
            { name: "Pozostałe instytucje finansowe (do 2 lat)", level: 3, columnId: 14 },
            { name: "Przedsiębiorstwa niefinansowe (do 2 lat)", level: 3, columnId: 15 },
            { name: "Instytucje niekomercyjne działające na rzecz gospodarstw domowych (do 2 lat)", level: 3, columnId: 16 },
            { name: "Instytucje samorządowe (do 2 lat)", level: 3, columnId: 17 },
            { name: "Fundusze zabezpieczenia społecznego (do 2 lat)", level: 3, columnId: 18 },
            { name: "Pieniądz M1", level: 2, columnId: 11 },
            { name: "Depozyty bieżące", level: 3, columnId: 4 },
            { name: "Gospodarstwa domowe (bieżące)", level: 4, columnId: 5 },
            { name: "Pozostałe instytucje finansowe (bieżące)", level: 4, columnId: 6 },
            { name: "Przedsiębiorstwa niefinansowe (bieżące)", level: 4, columnId: 7 },
            { name: "Instytucje niekomercyjne działające na rzecz gospodarstw domowych (bieżące)", level: 4, columnId: 8 },
            { name: "Instytucje samorządowe (bieżące)", level: 4, columnId: 9 },
            { name: "Fundusze zabezpieczenia społecznego (bieżące)", level: 4, columnId: 10 },
            { name: "PIENIĄDZ GOTÓWKOWY W OBIEGU (POZA KASAMI MIF)", level: 3, columnId: 1 }
        ];

        async function renderTreeTable() {
            try {
                const response = await fetch('am_data.json');
                const data = await response.json();
                const columns = data.columns;
                function getLatestValue(col) {
                    if (!col || !col.data || !col.data.length) return null;
                    return col.data[col.data.length - 1];
                }
                function getValueForMonth(col, dateString) {
                    if (!col || !col.data || !col.data.length) return null;
                    return col.data.find(x => x.date.startsWith(dateString));
                }
                let latestMonth = null;
                for (const col of columns) {
                    if (col.data && col.data.length) {
                        const last = col.data[col.data.length - 1];
                        if (!latestMonth || last.date > latestMonth) latestMonth = last.date;
                    }
                }
                if (!latestMonth) return;
                const [latestYear, latestM, ] = latestMonth.split("-");
                const prevYearDate = (parseInt(latestYear)-1) + '-' + latestM;
                let prevMonthYear = parseInt(latestM) === 1 ? parseInt(latestYear)-1 : latestYear;
                let prevMonthMonth = parseInt(latestM) === 1 ? 12 : String(parseInt(latestM)-1).padStart(2, "0");
                const prevMonthDate = prevMonthYear + "-" + prevMonthMonth;
                let rows = "";
                for (const item of treeStructure) {
                    let col = item.columnId ? columns.find(x => x.column_id === item.columnId) : null;
                    let latest = getLatestValue(col);
                    let value = latest ? (latest.value/1000) : null;
                    let prevYear = col ? getValueForMonth(col, prevYearDate) : null;
                    let prevYearValue = prevYear ? (prevYear.value/1000) : null;
                    let prevMonth = col ? getValueForMonth(col, prevMonthDate) : null;
                    let prevMonthValue = prevMonth ? (prevMonth.value/1000) : null;
                    let rrAbs = (value!==null && prevYearValue!==null) ? (value - prevYearValue) : null;
                    let mmAbs = (value!==null && prevMonthValue!==null) ? (value - prevMonthValue) : null;
                    let rrPct = (rrAbs!==null && prevYearValue) ? (rrAbs / prevYearValue * 100) : null;
                    let mmPct = (mmAbs!==null && prevMonthValue) ? (mmAbs / prevMonthValue * 100) : null;
                    const num = (n, d=2) => n===null ? "brak danych" : n.toLocaleString("pl-PL", {minimumFractionDigits: d, maximumFractionDigits: d});
                    const colored = (n, d=2) => n===null ? "brak danych" : `<span class="${n>=0?'positive-value':'negative-value'}">${n>=0?'+':''}${num(n, d)}</span>`;
                    rows += `<tr>
                        <td class="tree-indent-${item.level}">${item.name}</td>
                        <td>${num(value,2)}</td>
                        <td>${colored(rrAbs,2)}</td>
                        <td>${colored(mmAbs,2)}</td>
                        <td>${colored(rrPct,2)}%</td>
                        <td>${colored(mmPct,2)}%</td>
                    </tr>`;
                }
                document.getElementById('tree-table-body').innerHTML = rows;
            } catch (err) {
                document.getElementById('tree-table-body').innerHTML = '<tr><td colspan="6">Błąd ładowania danych</td></tr>';
                console.error(err);
            }
        }

        // Inicjalizacja wszystkich sekcji po załadowaniu strony
        window.onload = function() {
            loadData();
            renderTreeTable();
        };
    </script>
</body>
</html>
